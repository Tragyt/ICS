{% extends "base.html" %}
{% block content %}

{% include "webauthn.html" %}

<div class="flex flex-col justify-center items-center min-h-screen -translate-y-16">

    {% if setup and userhandler %}
    <div class="bg-blue-100 text-blue-800 border border-blue-300 rounded p-4 mb-4 max-w-md text-center">
        Attenzione!!
        Inserire TOKEN di inizializzazione.
        Verrà creato l'utente <strong>admin</strong>
    </div>
    {% endif %}

    <form id="loginForm">
        <div class="flex-col flex">
            <label for="username" class="mb-1 font-bold">Username</label>
            <input type="text" id="username" name="username" required class="border border-black rounded shadow p-1">
        </div>
        <div>
            <button
                class="bg-green-600 font-bold py-2 px-4 mt-2 uppercase shadow text-white rounded hover:bg-green-700 hover:shadow-lg"
                type="submit">
                Login
            </button>
        </div>
    </form>
    <div id="errorMsg" class="text-red-600 mt-2 hidden"></div>
</div>

<script>
    document.getElementById("loginForm").addEventListener('submit', async (e) => {
        e.preventDefault();

        const username = e.target.username.value;
        const errorDiv = document.getElementById('errorMsg');
        const next_url = {{next | tojson}};

        try {
            if ({{ setup | tojson }}) 
            {
                const response = await fetch('/usermanagement/setup-user',
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token: username })
                    }
                );
                const result = await response.json();
                
                if (response.ok) {
                    user_id = result.user_id;
                    jsonOptions = JSON.parse(result.publicCredentialCreationOptions);
                    token = result.token;

                    let webauthn_response;
                    webauthn_response = await SimpleWebAuthnBrowser.startRegistration(jsonOptions);

                    const verifyResponse = await fetch('/usermanagement/verify-setup-user', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            credential: webauthn_response,
                            challenge: Uint8Array.from(jsonOptions.challenge, c => c.charCodeAt(0)),
                            user_id: user_id,
                            token: token
                        })
                    });
                    const verifyJson = await verifyResponse.json();
                    if (verifyJson.status == 'ok')
                        alert("Registrazione completata con successo!");
                    else {
                        delete_user(user_id);
                        return false;
                    }

                    window.location.href = "{{ url_for('login') }}";
                }
            }
            else{
                const response = await fetch('/userlogin/autentication-options',
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username: username })
                    }
                );
                authenticationOptions = await response.json();
                jsonOptions = JSON.parse(authenticationOptions);

                let asseResp;
                try {
                    asseResp = await startAuthentication(jsonOptions);
                } catch (error) {
                    alert("Qualcosa è andato storto");
                    console.error(error)
                }

                const authenticationResponse = await fetch('/userlogin/login-verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(
                        {
                            credential: asseResp,
                            username: username
                        }
                    )
                });
                const authenticationResult = await authenticationResponse.json();
                if (authenticationResult.success){
                    console.log(next_url);
                    window.location.href = next_url;
                }
                    
                else {
                    errorDiv.textContent = 'Autenticazione fallita';
                    errorDiv.classList.remove('hidden');
                }
                
            }
        } catch (error) {
            errorDiv.textContent = 'Autenticazione fallita';
            errorDiv.classList.remove('hidden');
        }
    });

    
</script>
{% endblock content %}